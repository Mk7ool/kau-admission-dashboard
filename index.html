<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¨ÙˆÙ„ - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù„Ùƒ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(to bottom, #e3f2fd, #ffffff);
      padding: 20px;
      direction: rtl;
    }
    h1 { text-align: center; margin-bottom: 30px; color: #0d47a1; }
    .filters { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin: 20px 0; }
    select, input[type="file"] {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    .cards { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-bottom: 40px; }
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      min-width: 200px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    .chart-container {
      margin: 40px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 95%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
<h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¨ÙˆÙ„ - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù„Ùƒ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²</h1>

<div class="filters">
  <input type="file" id="upload" accept=".xlsx,.xls" />
  <select id="collegeFilter"><option value="">ğŸ“š ÙƒÙ„ Ø§Ù„ÙƒÙ„ÙŠØ§Øª</option></select>
  <select id="genderFilter"><option value="">ğŸ‘¥ ÙƒÙ„ Ø§Ù„Ø¬Ù†Ø³ÙŠÙ†</option><option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option><option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option></select>
  <select id="locationFilter"><option value="">ğŸ“ ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</option></select>
  <select id="programFilter"><option value="">ğŸ“ ÙƒÙ„ Ø§Ù„ØªØ®ØµØµØ§Øª</option></select>
</div>

<div class="cards" id="statsCards"></div>

<div id="charts">
  <div class="chart-container"><canvas id="assignedPerCollege"></canvas></div>
  <div class="chart-container"><canvas id="assignedPerProgram"></canvas></div>
  <div class="chart-container"><canvas id="assignedPerLocation"></canvas></div>
  <div class="chart-container"><canvas id="genderDistribution"></canvas></div>
  <div class="chart-container"><canvas id="minScorePerProgram"></canvas></div>
  <div class="chart-container"><canvas id="disabilityRatioPerProgram"></canvas></div>
</div>

<script>
let originalData = [];

const uploadInput = document.getElementById("upload");
const collegeFilter = document.getElementById("collegeFilter");
const genderFilter = document.getElementById("genderFilter");
const locationFilter = document.getElementById("locationFilter");
const programFilter = document.getElementById("programFilter");

uploadInput.addEventListener("change", function (e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function (evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    originalData = json;
    populateFilters(json);
    updateDashboard(json);
  };
  reader.readAsArrayBuffer(file);
});

function populateFilters(data) {
  const colleges = new Set();
  const locations = new Set();
  const programs = new Set();

  data.forEach(row => {
    colleges.add(row["Ø§Ù„ÙƒÙ„ÙŠØ©"]);
    locations.add(row["Ø§Ù„Ù…ÙˆÙ‚Ø¹"]);
    if (row["Ø§Ù„ØªØ®ØµØµ"]) {
      programs.add(row["Ø§Ù„ØªØ®ØµØµ"].includes("Ø¹Ø§Ù…") ? `${row["Ø§Ù„ØªØ®ØµØµ"]} (${row["Ø§Ù„ÙƒÙ„ÙŠØ©"]})` : row["Ø§Ù„ØªØ®ØµØµ"]);
    }
  });

  fillSelect(collegeFilter, colleges);
  fillSelect(locationFilter, locations);
  fillSelect(programFilter, programs);
}

function fillSelect(select, values) {
  select.innerHTML = select.options[0].outerHTML;
  Array.from(values).sort().forEach(val => {
    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = val;
    select.appendChild(opt);
  });
}

[collegeFilter, genderFilter, locationFilter, programFilter].forEach(filter => {
  filter.addEventListener("change", () => {
    const filtered = originalData.filter(row =>
      (!collegeFilter.value || row["Ø§Ù„ÙƒÙ„ÙŠØ©"] === collegeFilter.value) &&
      (!genderFilter.value || row["Ø§Ù„Ø¬Ù†Ø³"] === genderFilter.value) &&
      (!locationFilter.value || row["Ø§Ù„Ù…ÙˆÙ‚Ø¹"] === locationFilter.value) &&
      (!programFilter.value || (row["Ø§Ù„ØªØ®ØµØµ"]?.includes("Ø¹Ø§Ù…") ? `${row["Ø§Ù„ØªØ®ØµØµ"]} (${row["Ø§Ù„ÙƒÙ„ÙŠØ©"]})` : row["Ø§Ù„ØªØ®ØµØµ"]) === programFilter.value)
    );
    updateDashboard(filtered);
  });
});

function updateDashboard(data) {
  const stats = {
    totalAssigned: 0,
    totalCapacity: 0,
    minScore: Infinity,
    maleAssigned: 0,
    femaleAssigned: 0,
    disabledAssigned: 0
  };

  const assignedByCollege = {}, assignedByProgram = {}, assignedByLocation = {}, minScoreByProgram = {}, disabilityRatioByProgram = {};

  data.forEach(row => {
    const college = row["Ø§Ù„ÙƒÙ„ÙŠØ©"];
    const location = row["Ø§Ù„Ù…ÙˆÙ‚Ø¹"];
    const gender = row["Ø§Ù„Ø¬Ù†Ø³"];
    const capacity = +row["Ø§Ù„Ø³Ø¹Ø©"] || 0;
    const assigned = +row["Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹ÙŠÙ†ÙŠÙ†"] || 0;
    const disabled = +row["Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹ÙŠÙ†ÙŠÙ† Ù…Ù† Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø©"] || 0;
    const score = +row["Ø£Ù‚Ù„ Ù†Ø³Ø¨Ø© Ù…ÙˆØ²ÙˆÙ†Ø©"] || 0;
    const program = row["Ø§Ù„ØªØ®ØµØµ"]?.includes("Ø¹Ø§Ù…") ? `${row["Ø§Ù„ØªØ®ØµØµ"]} (${row["Ø§Ù„ÙƒÙ„ÙŠØ©"]})` : row["Ø§Ù„ØªØ®ØµØµ"];

    stats.totalAssigned += assigned;
    stats.totalCapacity += capacity;
    stats.disabledAssigned += disabled;
    if (score > 0 && score < stats.minScore) stats.minScore = score;
    if (gender === "Ø°ÙƒØ±") stats.maleAssigned += assigned;
    if (gender === "Ø£Ù†Ø«Ù‰") stats.femaleAssigned += assigned;

    if (college) assignedByCollege[college] = (assignedByCollege[college] || 0) + assigned;
    if (program) assignedByProgram[program] = (assignedByProgram[program] || 0) + assigned;
    if (location) assignedByLocation[location] = (assignedByLocation[location] || 0) + assigned;
    if (program && score > 0) minScoreByProgram[program] = score;
    if (program && assigned > 0) disabilityRatioByProgram[program] = +(disabled / assigned * 100).toFixed(1);
  });

  document.getElementById("statsCards").innerHTML = `
    <div class="card"><h3>ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ÙŠÙ†</h3><p>${stats.totalAssigned.toLocaleString()}</p></div>
    <div class="card"><h3>ğŸ¯ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø´ØºØ§Ù„</h3><p>${stats.totalCapacity ? ((stats.totalAssigned / stats.totalCapacity) * 100).toFixed(1) + "%" : "-"}</p></div>
    <div class="card"><h3>ğŸ“‰ Ø£Ù‚Ù„ Ù†Ø³Ø¨Ø© Ù…ÙˆØ²ÙˆÙ†Ø©</h3><p>${isFinite(stats.minScore) ? stats.minScore.toFixed(2) : "-"}</p></div>
    <div class="card"><h3>ğŸ‘¨ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ÙˆÙ† Ø·Ù„Ø§Ø¨</h3><p style="color: #1e88e5;">${stats.maleAssigned.toLocaleString()}</p></div>
    <div class="card"><h3>ğŸ‘© Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø§Øª Ø·Ø§Ù„Ø¨Ø§Øª</h3><p style="color: #c2185b;">${stats.femaleAssigned.toLocaleString()}</p></div>
    <div class="card"><h3>â™¿ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ÙŠÙ† Ù…Ù† Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø©</h3><p style="color: #6a1b9a;">${stats.disabledAssigned.toLocaleString()}</p></div>
  `;

  const useGenderColors = !genderFilter.value;
  drawChart("assignedPerCollege", "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„ÙƒÙ„ÙŠØ©", assignedByCollege, useGenderColors);
  drawChart("assignedPerProgram", "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„ØªØ®ØµØµ", assignedByProgram, useGenderColors);
  drawChart("assignedPerLocation", "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹", assignedByLocation, useGenderColors);
  drawChart("genderDistribution", "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³", { "Ø°ÙƒÙˆØ±": stats.maleAssigned, "Ø¥Ù†Ø§Ø«": stats.femaleAssigned }, ["#1e88e5", "#c2185b"]);
  drawChart("minScorePerProgram", "Ø£Ù‚Ù„ Ù†Ø³Ø¨Ø© Ù…ÙˆØ²ÙˆÙ†Ø© Ù„ÙƒÙ„ ØªØ®ØµØµ", minScoreByProgram, useGenderColors);
  drawChart("disabilityRatioPerProgram", "Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ÙŠÙ† Ù…Ù† Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø© Ù„ÙƒÙ„ ØªØ®ØµØµ", disabilityRatioByProgram, useGenderColors);
}

function drawChart(id, label, dataObj, useGenderColors = false) {
  const canvas = document.getElementById(id);
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  if (window[id + "_instance"]) window[id + "_instance"].destroy();

  const colors = ["#1e88e5", "#c2185b"];
  const bgColors = useGenderColors && Object.keys(dataObj).length > 1
    ? Object.keys(dataObj).map((_, i) => colors[i % 2])
    : '#42a5f5';

  window[id + "_instance"] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(dataObj),
      datasets: [{
        label: label,
        data: Object.values(dataObj),
        backgroundColor: bgColors
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: label },
        legend: { display: false }
      },
      indexAxis: Object.keys(dataObj).length > 5 ? 'y' : 'x'
    }
  });
}
</script>
</body>
</html>
