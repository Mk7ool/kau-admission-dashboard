<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة بيانات القبول - جامعة الملك عبدالعزيز</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(to bottom, #e3f2fd, #ffffff);
      padding: 20px;
      direction: rtl;
    }
    h1 { text-align: center; margin-bottom: 30px; color: #0d47a1; }
    .filters { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin: 20px 0; }
    select, input[type="file"] {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    .cards { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-bottom: 40px; }
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      min-width: 200px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    .chart-container {
      margin: 40px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 95%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
<h1>📊 لوحة بيانات القبول - جامعة الملك عبدالعزيز</h1>

<div class="filters">
  <input type="file" id="upload" accept=".xlsx,.xls" />
  <select id="collegeFilter"><option value="">📚 كل الكليات</option></select>
  <select id="genderFilter"><option value="">👥 كل الجنسين</option><option value="ذكر">ذكر</option><option value="أنثى">أنثى</option></select>
  <select id="locationFilter"><option value="">📍 كل المواقع</option></select>
  <select id="programFilter"><option value="">🎓 كل التخصصات</option></select>
</div>

<div class="cards" id="statsCards"></div>

<div id="charts">
  <div class="chart-container"><canvas id="assignedPerCollege"></canvas></div>
  <div class="chart-container"><canvas id="assignedPerProgram"></canvas></div>
  <div class="chart-container"><canvas id="assignedPerLocation"></canvas></div>
  <div class="chart-container"><canvas id="genderDistribution"></canvas></div>
  <div class="chart-container"><canvas id="minScorePerProgram"></canvas></div>
</div>

<script>
let originalData = [];

const collegeFilter = document.getElementById('collegeFilter');
const genderFilter = document.getElementById('genderFilter');
const locationFilter = document.getElementById('locationFilter');
const programFilter = document.getElementById('programFilter');

function resetDashboard() {
  document.getElementById("statsCards").innerHTML = "";
  ["assignedPerCollege","assignedPerProgram","assignedPerLocation","genderDistribution","minScorePerProgram"].forEach(id => {
    if (window[id + "_instance"]) {
      window[id + "_instance"].destroy();
      window[id + "_instance"] = null;
    }
  });
}

function populateFilters(data) {
  const collegeSet = new Set();
  const locationSet = new Set();
  const programSet = new Set();

  data.forEach(row => {
    if (row["الكلية"]) collegeSet.add(row["الكلية"]);
    if (row["الموقع"]) locationSet.add(row["الموقع"]);
    if (row["التخصص"]) programSet.add(row["التخصص"].includes("عام") ? `${row["التخصص"]} (${row["الكلية"]})` : row["التخصص"]);
  });

  const populate = (id, set) => {
    const select = document.getElementById(id);
    const first = select.options[0];
    select.innerHTML = "";
    select.appendChild(first);
    [...set].sort().forEach(val => {
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
  };

  populate("collegeFilter", collegeSet);
  populate("locationFilter", locationSet);
  populate("programFilter", programSet);
}

function filterAndGenerate() {
  const filtered = originalData.filter(row =>
    (!collegeFilter.value || row["الكلية"] === collegeFilter.value) &&
    (!genderFilter.value || row["الجنس"] === genderFilter.value) &&
    (!locationFilter.value || row["الموقع"] === locationFilter.value) &&
    (!programFilter.value || (row["التخصص"]?.includes("عام") ? `${row["التخصص"]} (${row["الكلية"]})` : row["التخصص"]) === programFilter.value)
  );
  generateDashboard(filtered);
}

["collegeFilter", "genderFilter", "locationFilter", "programFilter"].forEach(id => {
  document.getElementById(id).addEventListener("change", filterAndGenerate);
});

document.getElementById('upload').addEventListener('change', function(e) {
  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, {type: 'array'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    
    originalData = json;
    populateFilters(json);
    generateDashboard(json);
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});

function generateDashboard(data) {
  resetDashboard();
  const stats = { totalAccepted: 0, totalCapacity: 0, minScore: Infinity, maleAccepted: 0, femaleAccepted: 0 };
  const acceptedByCollege = {}, acceptedByProgram = {}, acceptedByLocation = {}, minScoreByProgram = {};

  data.forEach(row => {
    const college = row["الكلية"];
    const program = row["التخصص"]?.includes("عام") ? `${row["التخصص"]} (${college})` : row["التخصص"];
    const location = row["الموقع"];
    const gender = row["الجنس"];
    const accepted = +row["عدد المعينين"] || 0;
    const capacity = +row["السعة"] || 0;
    const score = +row["أقل نسبة موزونة"] || 0;

    if (!program) return;

    stats.totalAccepted += accepted;
    stats.totalCapacity += capacity;
    if (score > 0 && score < stats.minScore) stats.minScore = score;
    if (gender === "ذكر") stats.maleAccepted += accepted;
    else if (gender === "أنثى") stats.femaleAccepted += accepted;

    acceptedByCollege[college] = (acceptedByCollege[college] || 0) + accepted;
    acceptedByProgram[program] = (acceptedByProgram[program] || 0) + accepted;
    acceptedByLocation[location] = (acceptedByLocation[location] || 0) + accepted;
    if (!minScoreByProgram[program] || score < minScoreByProgram[program]) minScoreByProgram[program] = score;
  });

  document.getElementById("statsCards").innerHTML = `
    <div class="card"><h3>📦 عدد المقبولين</h3><p>${stats.totalAccepted.toLocaleString()}</p></div>
    <div class="card"><h3>🎯 نسبة الإشغال</h3><p>${stats.totalCapacity ? ((stats.totalAccepted / stats.totalCapacity) * 100).toFixed(1) + "%" : "-"}</p></div>
    <div class="card"><h3>📉 أقل نسبة موزونة</h3><p>${isFinite(stats.minScore) ? stats.minScore.toFixed(2) : "-"}</p></div>
    <div class="card"><h3>👨 المقبولين طلاب</h3><p style="color: #1e88e5;">${stats.maleAccepted.toLocaleString()}</p></div>
    <div class="card"><h3>👩 المقبولين طالبات</h3><p style="color: #c2185b;">${stats.femaleAccepted.toLocaleString()}</p></div>
  `;

  drawChart("assignedPerCollege", "عدد المقبولين حسب الكلية", acceptedByCollege);
  drawChart("assignedPerProgram", "عدد المقبولين حسب التخصص", acceptedByProgram);
  drawChart("assignedPerLocation", "عدد المقبولين حسب الموقع", acceptedByLocation);
  drawChart("genderDistri
  drawChart("minScorePerProgram", "أقل نسبة موزونة لكل تخصص", minScoreByProgram);
}

function drawChart(id, label, dataObj, colors=null) {
  const canvas = document.getElementById(id);
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  if (window[id + "_instance"]) window[id + "_instance"].destroy();

  window[id + "_instance"] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Object.keys(dataObj),
      datasets: [{
        label: label,
        data: Object.values(dataObj),
        backgroundColor: colors || '#42a5f5'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: label },
        legend: { display: false }
      },
      indexAxis: Object.keys(dataObj).length > 5 ? 'y' : 'x'
    }
  });
}
</script>
</body>
</html>
